{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="{% static 'js/app.js' %}"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</head>
  ]
   
</head>
<body class="gradient-custom">
    <section style="align-items: center; justify-content: center; col-12">
        <div class="container py-5 align-items-center col-12">
            <form class="col-12" method="POST"  id="projectForm">
                {% csrf_token %}
                <div class="col-12" style="height: 100vh; display: flex; flex-direction:column; align-items: center;" >
                    <div class="form-group col-12" class="form" >
                        <center><label for="exampleInputEmail1" style="color:white" class="col-8">Enter project name</label></center> <br>
                        <input type="text" id="exampleInputEmail1" class="col-11 input-size" aria-describedby="emailHelp" placeholder="Enter project" name="project">
                    </div>
                    <div class="form-group col-12  div0"  id="parents" style="margin:0; padding:0">
                       {% include "app/module.html" %}
                       </div>
                    <button type="submit" class="btn btn-primary col-4 input-size mt-5">Save</button>
                </div>
            </form>
        </div>
    </section>
       
    <script>
        $(document).ready( function () {
            $(document).on('click', `.plus`, function() {
                let newid = $(this).attr("class")
                newid = newid.replace("btn btn-success", "").trim();
                $(`.${newid}`).hide();
                $.ajax({
                    url: `app/module/`,
                    type: "GET",
                    success: function (response) {
                        $(`.div0`).append(response);
                    },
                    error: function (xhr, status, error) {
                        console.error(error);
                    },
                });
            });

            $(document).on('click', `.minus`, function() {
                var parentDiv = $(this).closest('.form-group');
                var minusBtns = $('.minus');
                var parentsLength = $('#parents').children().length;
                var isLastMinus = minusBtns.last().is(this);
                if (isLastMinus) {
                    var closestFormGroupSiblings = parentDiv.prev('.form-group');
                    closestFormGroupSiblings.find('.plus, .minus').show();
                    parentDiv.remove();
                    if (parentsLength <=1){
                        location.reload()
                    }
                 } 
                else{
                    parentDiv.remove()
                  
                }
            });
        });

           
        $(document).ready(function() {
            $(document).on('submit', '#projectForm', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                fetch(this.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "error") {
                        Toastify({
                            text: data.message,
                            duration: 3000,
                            close: true,
                            gravity: "top",
                            position: "right",
                            stopOnFocus: true,
                            style: {
                                background: "#dc3545",
                                color: "#fff",
                            },
                            onClick: function () {},
                        }).showToast();
                    } else {
                        Toastify({
                            text: data.message,
                            duration: 3000,
                            close: true,
                            gravity: "top",
                            position: "right",
                            stopOnFocus: true,
                            style: {
                                background: "#28a745",
                                color: "#fff",
                            },
                            onClick: function () {},
                        }).showToast();
                        $('#projectForm')[0].reset();
                        
                    }
                })
                .catch(error => {
                    Toastify({
                        text: 'An unexpected error occurred. Please try again.',
                        duration: 3000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        stopOnFocus: true,
                        style: {
                            background: "#dc3545",
                            color: "#fff",
                        },
                        onClick: function () {},
                    }).showToast();
                    console.error('Error:', error);
                });
            });
        })
    </script>
</body>
</html>